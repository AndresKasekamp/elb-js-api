import{mj as j,gU as G,fR as J,mk as B,gW as Q,ab as V,ml as K,mm as M,gL as D,mn as Z,av as $,W as ee,mo as te,mp as Y}from"./index-pCX-0tJH.js";import{d as ae,n as F,a as N,t as q,b as re,r as ie,l as se,e as ne,j as oe,V as ce,Q as le}from"./cimAnalyzer-X6MTpVAO.js";import{r as he,e as me}from"./rasterizingUtils-_-kX1RtA.js";import"./labelPoint-1MOq4I_J.js";import"./TileClipper-NSFZXMR1.js";import"./definitions-SVBNHUSH.js";import"./number-sTjsTbdA.js";import"./BidiEngine-8z8MVveq.js";class ge{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(e){return this._resourceMap.get(e)??null}async fetchResource(e,t){const o=this._resourceMap.get(e);if(o)return{width:o.width,height:o.height};let a=this._inFlightResourceMap.get(e);return a?a.then(r=>({width:r.width,height:r.height})):(a=j(e,t),this._inFlightResourceMap.set(e,a),a.then(r=>(this._inFlightResourceMap.delete(e),this._resourceMap.set(e,r),{width:r.width,height:r.height}),()=>({width:0,height:0})))}deleteResource(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}loadFont(e){return G(e)}}const ue=512;class fe{constructor(e){this._resourceManager=e,this._lazyRasterizationCanvas=null}dispose(){this._lazyRasterizationCanvas=null}get _rasterizationCanvas(){return this._lazyRasterizationCanvas==null&&(this._lazyRasterizationCanvas=document.createElement("canvas"),this._lazyRasterizationCanvas.getContext("2d",{willReadFrequently:!0})),this._lazyRasterizationCanvas}rasterizeJSONResource(e,t,o){if(e.type==="simple-fill"||e.type==="esriSFS"){const[i,h,p]=he(this._rasterizationCanvas,e.style,t);return{size:[h,p],image:new Uint32Array(i.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:J(Math.ceil(t))}}if(e.type==="simple-line"||e.type==="esriSLS"||e.type==="line"&&e.dashTemplate){let i,h;if(e.type==="simple-line"||e.type==="esriSLS")switch(i=ae(e.style,e.cap),e.cap){case"butt":h="Butt";break;case"square":h="Square";break;default:h="Round"}else i=e.dashTemplate,h=e.cim.capStyle;const[p,f,d]=me(i,h);return{size:[f,d],image:new Uint32Array(p.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let a,r=null,c=null,n=1;if(e.type==="simple-marker"||e.type==="esriSMS"||e.type==="line-marker"?(a=F.fromSimpleMarker(e),c=N(a)):e.cim&&e.cim.type==="CIMHatchFill"?(a=F.fromCIMHatchFill(e.cim,t),r=new q(a.frame.xmin,-a.frame.ymax,a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin),n=t):e.cim.markerPlacement&&e.cim.markerPlacement.type==="CIMMarkerPlacementInsidePolygon"?(a=F.fromCIMInsidePolygon(e.cim),r=new q(a.frame.xmin,-a.frame.ymax,a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin)):(a=e.cim,e.avoidSDFRasterization||(c=N(a))),c&&!o){const[i,h,p]=re(c);return i?{size:[h,p],image:new Uint32Array(i.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:n}:null}const[s,y,m,g,u]=F.rasterize(this._rasterizationCanvas,a,r,this._resourceManager,!o);return s?{size:[y,m],image:new Uint32Array(s.buffer),sdf:!1,simplePattern:!1,anchorX:g,anchorY:u}:null}rasterizeImageResource(e,t,o,a){this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;const r=this._rasterizationCanvas.getContext("2d");o instanceof ImageData?r.putImageData(o,0,0):(o.setAttribute("width",`${e}px`),o.setAttribute("height",`${t}px`),r.drawImage(o,0,0,e,t));const c=r.getImageData(0,0,e,t),n=new Uint8Array(c.data);if(a){for(const i of a)if(i&&i.oldColor&&i.oldColor.length===4&&i.newColor&&i.newColor.length===4){const[h,p,f,d]=i.oldColor,[z,l,I,w]=i.newColor;if(h===z&&p===l&&f===I&&d===w)continue;for(let C=0;C<n.length;C+=4)h===n[C]&&p===n[C+1]&&f===n[C+2]&&d===n[C+3]&&(n[C]=z,n[C+1]=l,n[C+2]=I,n[C+3]=w)}}let s;for(let i=0;i<n.length;i+=4)s=n[i+3]/255,n[i]=n[i]*s,n[i+1]=n[i+1]*s,n[i+2]=n[i+2]*s;let y=n,m=e,g=t;const u=ue;if(m>=u||g>=u){const i=m/g;i>1?(m=u,g=Math.round(u/i)):(g=u,m=Math.round(u*i)),y=new Uint8Array(4*m*g);const h=new Uint8ClampedArray(y.buffer);B(n,e,t,h,m,g,!1)}return{size:[m,g],image:new Uint32Array(y.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}const T=R=>R!=null&&R.scaleFactor?R.scaleFactor:1,de=96/72;class Ie{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._lazyImageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new ie,this._cimResourceManager=new ge,this._rasterizer=new fe(this._cimResourceManager)}get _imageDataCanvas(){return this._lazyImageDataCanvas??(this._lazyImageDataCanvas=document.createElement("canvas")),this._lazyImageDataCanvas}get _imageDataContext(){return this._imageDataCanvas.getContext("2d",{willReadFrequently:!0})}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,t,o,a,r,c,n,s,y){if(!e)return null;const{data:m}=e;if(!m||m.type!=="CIMSymbolReference"||!m.symbol)return null;const{symbol:g}=m;c||(c=Q(g));const u=await se.resolveSymbolOverrides(m,t,this._spatialReference,r,c,n,s),i=this._imageDataCanvas,h=this._cimResourceManager,p=[];F.fetchResources(u,h,p),F.fetchFonts(u,h,p),p.length>0&&await Promise.all(p);const{width:f,height:d}=o,z=ye(c,f,d,a),l=F.getEnvelope(u,z,h);if(!l)return null;const I=(window.devicePixelRatio||1)*de;let w=1,C=0,b=0;switch(g.type){case"CIMPointSymbol":case"CIMTextSymbol":{let k=1;l.width>f&&(k=f/l.width);let _=1;l.height>d&&(_=d/l.height),a==="preview"&&(l.width<f&&(k=f/l.width),l.height<d&&(_=d/l.height)),w=Math.min(k,_),C=l.x+l.width/2,b=l.y+l.height/2}break;case"CIMLineSymbol":{(y||l.height>d)&&(w=d/l.height),b=l.y+l.height/2;const k=l.x*w+f/2,_=(l.x+l.width)*w+f/2,{paths:x}=z;x[0][0][0]-=k/w,x[0][2][0]-=(_-f)/w}break;case"CIMPolygonSymbol":{C=l.x+l.width/2,b=l.y+l.height/2;const k=l.x*w+f/2,_=(l.x+l.width)*w+f/2,x=l.y*w+d/2,X=(l.y+l.height)*w+d/2,{rings:S}=z;k<0&&(S[0][0][0]-=k,S[0][3][0]-=k,S[0][4][0]-=k),x<0&&(S[0][0][1]+=x,S[0][1][1]+=x,S[0][4][1]+=x),_>f&&(S[0][1][0]-=_-f,S[0][2][0]-=_-f),X>d&&(S[0][2][1]+=X-d,S[0][3][1]+=X-d)}}i.width=f*I,i.height=d*I;const v=1;i.width+=2*v,i.height+=2*v;const P=this._imageDataContext,A=le.createIdentity();return A.translate(-C,-b),A.scale(w*I,-w*I),A.translate(f*I/2+v,d*I/2+v),P.clearRect(0,0,i.width,i.height),new ne(P,h,A,!0).drawSymbol(u,z),P.getImageData(0,0,i.width,i.height)}async analyzeCIMSymbol3D(e,t,o,a,r){const c=[],n=t?{geometryType:a,spatialReference:this._spatialReference,fields:t}:null,s=[];F.fetchFonts(e.data.symbol,this._cimResourceManager,s),await Promise.all(s);const y=new oe(this._cimResourceManager,n);let m;await y.analyzeSymbolReference(e.data,this._avoidSDF,c),V(r);for(const g of c)g.cim.type!=="CIMPictureMarker"&&g.cim.type!=="CIMPictureFill"&&g.cim.type!=="CIMPictureStroke"||(m||(m=[]),m.push(this._fetchPictureMarkerResource(g,r))),o&&g.type==="text"&&typeof g.text=="string"&&g.text.includes("[")&&(g.text=K(o,g.text,g.cim.textCase));return m&&await Promise.all(m),c}rasterizeCIMSymbol3D(e,t,o,a,r,c){const n=[];for(const s of e){a&&typeof a.scaleFactor=="function"&&(a.scaleFactor=a.scaleFactor(t,r,c));const y=this._getRasterizedResource(s,t,o,a,r,c);if(!y)continue;let m=0,g=y.anchorX||0,u=y.anchorY||0,i=!1,h=0,p=0;if(o==="esriGeometryPoint"){const f=T(a);if(h=M(s.offsetX,t,r,c)*f||0,p=M(s.offsetY,t,r,c)*f||0,s.type==="marker")m=M(s.rotation,t,r,c)||0,i=s.rotateClockwise??!1;else if(s.type==="text"){if(m=M(s.angle,t,r,c)||0,s.horizontalAlignment!==void 0)switch(s.horizontalAlignment){case"left":g=-.5;break;case"right":g=.5;break;default:g=0}if(s.verticalAlignment!==void 0)switch(s.verticalAlignment){case"top":u=.5;break;case"bottom":u=-.5;break;case"baseline":u=-.25;break;default:u=0}}}y!=null&&n.push({angle:m,rotateClockWise:i,anchorX:g,anchorY:u,offsetX:h,offsetY:p,rasterizedResource:y})}return this.getSymbolImage(n)}getSymbolImage(e){const t=document.createElement("canvas"),o=t.getContext("2d");let a=0,r=0,c=0,n=0;const s=[];for(let u=0;u<e.length;u++){const i=e[u],h=i.rasterizedResource;if(!h)continue;const p=h.size,f=i.offsetX,d=i.offsetY,z=i.anchorX,l=i.anchorY,I=i.rotateClockWise||!1;let w=i.angle,C=D(f)-p[0]*(.5+z),b=D(d)-p[1]*(.5+l),v=C+p[0],P=b+p[1];if(w){I&&(w=-w);const _=Math.sin(w*Math.PI/180),x=Math.cos(w*Math.PI/180),X=C*x-b*_,S=C*_+b*x,U=C*x-P*_,H=C*_+P*x,L=v*x-P*_,O=v*_+P*x,W=v*x-b*_,E=v*_+b*x;C=Math.min(X,U,L,W),b=Math.min(S,H,O,E),v=Math.max(X,U,L,W),P=Math.max(S,H,O,E)}a=C<a?C:a,r=b<r?b:r,c=v>c?v:c,n=P>n?P:n;const A=o.createImageData(h.size[0],h.size[1]);A.data.set(new Uint8ClampedArray(h.image.buffer));const k={offsetX:f,offsetY:d,rotateClockwise:I,angle:w,rasterizedImage:A,anchorX:z,anchorY:l};s.push(k)}t.width=c-a,t.height=n-r;const y=-a,m=n;for(let u=0;u<s.length;u++){const i=s[u],h=this._imageDataToCanvas(i.rasterizedImage),p=i.rasterizedImage.width,f=i.rasterizedImage.height,d=y-p*(.5+i.anchorX),z=m-f*(.5-i.anchorY);if(i.angle){const l=(360-i.angle)*Math.PI/180;o.save(),o.translate(D(i.offsetX),-D(i.offsetY)),o.translate(y,m),o.rotate(l),o.translate(-y,-m),o.drawImage(h,d,z),o.restore()}else o.drawImage(h,d+D(i.offsetX),z-D(i.offsetY))}const g=new Z({x:y/t.width-.5,y:m/t.height-.5});return{imageData:t.width!==0&&t.height!==0?o.getImageData(0,0,t.width,t.height):o.createImageData(1,1),anchorPosition:g}}async _fetchPictureMarkerResource(e,t){const o=e.materialHash;if(!this._pictureMarkerCache.get(o)){const a=(await $(e.cim.url,{responseType:"image",signal:t==null?void 0:t.signal})).data;this._pictureMarkerCache.set(o,a)}}_imageDataToCanvas(e){const t=this._imageDataCanvas,o=this._imageDataContext;return t.width=e.width,t.height=e.height,o.putImageData(e,0,0),t}_imageTo32Array(e,t,o,a){const r=this._imageDataCanvas,c=this._imageDataContext;if(r.width=t,r.height=o,c.drawImage(e,0,0,t,o),a){c.save();const n=new ee(a);c.fillStyle=n.toHex(),c.globalCompositeOperation="multiply",c.fillRect(0,0,t,o),c.globalCompositeOperation="destination-atop",c.drawImage(e,0,0,t,o),c.restore()}return new Uint32Array(c.getImageData(0,0,t,o).data.buffer)}_getRasterizedResource(e,t,o,a,r,c){let n,s,y;if(e.type==="text")return this._rasterizeTextResource(e,t,a,r,c);({analyzedCIM:n,hash:s}=pe(e,t,r,c));const u=T(a);if(e.cim.type==="CIMPictureMarker"){const p=M(e.size,t,r,c)*u,{image:f,width:d,height:z}=this._getPictureResource(e,p,M(e.color,t,r,c));return y={image:f,size:[d,z],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},y}te(n,u,{preserveOutlineWidth:!1});const i=n;s+=o,a&&(s+=JSON.stringify(a));const h=this._resourceCache;return h.has(s)?h.get(s):(y=this._rasterizer.rasterizeJSONResource({cim:i,type:e.type,url:e.url,mosaicHash:s,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),h.set(s,y),y)}_rasterizeTextResource(e,t,o,a,r){var b,v,P;const c=T(o),n=M(e.text,t,a,r);if(!n||n.length===0)return null;const s=e.cim,y=M((s==null?void 0:s.fontFamilyName)||e.fontName,t,a,r),m=M(((b=s==null?void 0:s.font)==null?void 0:b.style)||e.style,t,a,r),g=M(((v=s==null?void 0:s.font)==null?void 0:v.weight)||e.weight,t,a,r),u=M(((P=s==null?void 0:s.font)==null?void 0:P.decoration)||e.decoration,t,a,r),i=M(e.size,t,a,r)*c,h=M(e.horizontalAlignment,t,a,r),p=M(e.verticalAlignment,t,a,r),f=Y(M(e.color,t,a,r)),d=Y(M(e.outlineColor,t,a,r)),z=M(e.outlineSize,t,a,r),l=e.backgroundColor!=null?Y(e.backgroundColor):null,I=e.borderLineColor!=null?Y(e.borderLineColor):null,w=e.borderLineWidth!=null?e.borderLineWidth:null,C={color:f,size:i,horizontalAlignment:h,verticalAlignment:p,font:{family:y,style:m,weight:g,decoration:u},halo:{size:z||0,color:d,style:m},backgroundColor:l,borderLine:I!=null&&w!=null?{color:I,size:w}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(n,C)}_getPictureResource(e,t,o){const a=this._pictureMarkerCache.get(e.materialHash);if(!a)return null;const r=a.height/a.width,c=t?r>1?D(t):D(t)/r:a.width,n=t?r>1?D(t)*r:D(t):a.height;return{image:this._imageTo32Array(a,c,n,o),width:c,height:n}}}function ye(R,e,t,o){const r=-e/2+1,c=e/2-1,n=t/2-1,s=-t/2+1;switch(R){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[r,0],[0,0],[c,0]]]};default:return o==="legend"?{rings:[[[r,n],[c,0],[c,s],[r,s],[r,n]]]}:{rings:[[[r,n],[c,n],[c,s],[r,s],[r,n]]]}}}function pe(R,e,t,o){let a,r;return typeof R.materialHash=="function"?(a=(0,R.materialHash)(e,t,o),r=ce(R.cim,R.materialOverrides)):(a=R.materialHash,r=R.cim),{analyzedCIM:r,hash:a}}export{Ie as CIMSymbolRasterizer};
